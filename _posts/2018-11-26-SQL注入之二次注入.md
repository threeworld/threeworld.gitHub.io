---
layout: post
title:  "SQL注入之二次注入"
date:   2018-11-26 20:15:33 +0700
categories: [Web安全, SQL注入]
---

## 0x00 原理

二次注入是指已存储在数据库或文件中的数据被读取后再次插入到SQL语句或者命令执行中。

**二次注入的原理：**在第一次往数据库插入数据时，仅仅是对特殊的字符进行转义，但保存在数据库中的数据恢复了原来的数据，就是存进数据库后，数据又被还原了，也就是反斜杠没了。如果开发者确信数据库中的数据都是可信的，那么在下一次需要查询该数据的时候，直接从数据库中取出了脏数据，没有进行进一步的检验和处理。这样就会造成SQL的二次注入。比如在第一次插入数据的时候，数据中带有单引号，直接插入到了数据库中；然后在下一次使用中在拼凑的过程中，就形成了二次注入。

![30080c5fc59b88d5fb7b823f8486a31]({{site.url}}/images/30080c5fc59b88d5fb7b823f8486a31.png)

## 0x01 构造思路

1. 黑客通过构造数据的形式，在浏览器或者其他软件中提交HTTP 数据报文请求到服务端进行处理，提交的数据报文请求中可能包含了黑客构造的SQL 语句或者命令。
2. 服务端应用程序会将黑客提交的数据信息进行存储，通常是保存在数据库中，保存的数据信息的主要作用是为应用程序执行其他功能提供原始输入数据并对客户端请求做出响应。
3. 黑客向服务端发送第二个与第一次不相同的请求数据信息。
4. 服务端接收到黑客提交的第二个请求信息后，为了处理该请求，服务端会查询数据库中已经存储的数据信息并处理，从而导致黑客在第一次请求中构造的SQL 语句或者命令在服务端环境中执行。
5. 服务端返回执行的处理结果数据信息，黑客可以通过返回的结果数据信息判断二次注入漏洞利用是否成功。

## 0x02 过程

一般在注册的账号时，数据都会存在数据库中，当我们注册一个admin’#的账号，接下来登录该帐号后进行修改密码。此时修改的就是admin 的密码。

**SQL语句：**

```sql
UPDATE users SET passwd="New_Pass" WHERE username =' admin' # ' AND password='
```

也就是执行了

```sql
UPDATE users SET passwd="New_Pass" WHERE username =' admin'
```

